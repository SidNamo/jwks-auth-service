<div class="bg-white shadow-md rounded-2xl p-6 relative">

    <!-- ‚úÖ ÏÉÅÎã® -->
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨</h2>
    </div>

    <!-- üîç ÌÜµÌï© Í≤ÄÏÉâ + ÏÉÅÏÑ∏ Í≤ÄÏÉâ -->
    <div class="mb-4">
        <form id="search_form" method="get" action="{{ request.base_url }}admin/users"
            class="flex flex-col items-end text-sm gap-3">

            <!-- 1) ÌÜµÌï© Í≤ÄÏÉâ Ìñâ -->
            <div class="flex items-center justify-between gap-2 relative w-full">
                <!-- ÏôºÏ™Ω: ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä Î≤ÑÌäº -->
                <button type="button"
                    class="bg-gray-200 text-gray-800 px-3 py-2 rounded text-sm hover:bg-gray-300 border border-gray-300"
                    onclick="openUserAddModal()">
                    ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä
                </button>

                <!-- Ïò§Î•∏Ï™Ω: Í≤ÄÏÉâÏ∞Ω + Î≤ÑÌäº -->
                <div class="flex items-center gap-2">
                    <input type="text" id="search_input" name="query" placeholder="Ïù¥Î¶Ñ, ID, UID Í≤ÄÏÉâ..."
                        value="{{ page.search.query or '' }}"
                        class="border border-gray-300 rounded-lg px-3 py-2 w-80 focus:ring focus:ring-indigo-200"
                        onfocus="openDetailSearch()">

                    <button type="button" class="bg-indigo-600 text-white px-4 py-2 rounded" onclick="doSearch(1)">
                        Í≤ÄÏÉâ
                    </button>
                </div>

                <!-- üì¶ ÏÉÅÏÑ∏ Í≤ÄÏÉâ Ìå®ÎÑê (Ï†àÎåÄ ÏúÑÏπò) -->
                <div id="detail_search_panel"
                    class="absolute top-12 right-0 w-[32rem] bg-white border border-gray-300 rounded-lg shadow-lg opacity-0 scale-y-0 origin-top transition-all duration-300 ease-out hidden z-40">
                    <div class="p-5 relative">
                        <button type="button" onclick="resetDetailSearch()"
                            class="absolute right-4 top-4 text-sm bg-red-500 hover:bg-red-600 text-white rounded px-3 py-1 shadow-sm transition">
                            Ï¥àÍ∏∞Ìôî
                        </button>

                        <h3 class="text-sm font-semibold mb-4 text-gray-700">ÏÉÅÏÑ∏ Í≤ÄÏÉâ</h3>

                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <label class="block mb-1 text-gray-600">UID</label>
                                <input type="text" name="uid" value="{{ page.search.uid or '' }}"
                                    class="border rounded px-2 py-1 w-full">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">ID</label>
                                <input type="text" name="id" value="{{ page.search.id or '' }}"
                                    class="border rounded px-2 py-1 w-full">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ïù¥Î¶Ñ</label>
                                <input type="text" name="name" value="{{ page.search.name or '' }}"
                                    class="border rounded px-2 py-1 w-full">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">ÏÉÅÌÉú</label>
                                <select name="status" class="border rounded px-2 py-2 w-full">
                                    <option value="">Ï†ÑÏ≤¥ ÏÉÅÌÉú</option>
                                    <option value="USE" {% if page.search.status=='USE' %}selected{% endif %}>ÏÇ¨Ïö©
                                    </option>
                                    <option value="WAIT" {% if page.search.status=='WAIT' %}selected{% endif %}>ÎåÄÍ∏∞
                                    </option>
                                    <option value="DEL" {% if page.search.status=='DEL' %}selected{% endif %}>ÌÉàÌá¥
                                    </option>
                                </select>
                            </div>
                            <div class="col-span-2">
                                <label class="block mb-1 text-gray-600">Í∞ÄÏûÖÏùº</label>
                                <div class="flex items-center gap-2">
                                    <input type="date" name="created_dt_start"
                                        value="{{ page.search.created_dt_start or '' }}"
                                        class="border rounded px-2 py-1 w-full">
                                    <span>~</span>
                                    <input type="date" name="created_dt_end"
                                        value="{{ page.search.created_dt_end or '' }}"
                                        class="border rounded px-2 py-1 w-full">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ‚úÖ ÏÇ¨Ïö©Ïûê ÌÖåÏù¥Î∏î -->
            <table class="w-full border-collapse text-sm">
                <thead>
                    <tr class="bg-gray-100 border-b">
                        <th class="p-2 text-left">UID</th>
                        <th class="p-2 text-left">ID</th>
                        <th class="p-2 text-left">Ïù¥Î¶Ñ</th>
                        <th class="p-2 text-center">ÏÉÅÌÉú</th>
                        <th class="p-2 text-left">Í∞ÄÏûÖÏùº</th>
                        <th class="p-2 text-left">Î≥ÄÍ≤ΩÏùº</th>
                        <th class="p-2 text-center">Í¥ÄÎ¶¨</th>
                    </tr>
                </thead>
                <tbody>
                    {% if page.content %}
                    {% for u in page.content %}
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2">{{ u.uid }}</td>
                        <td class="p-2">{{ u.id }}</td>
                        <td class="p-2">{{ u.name }}</td>
                        <td class="p-2 text-center">
                            {% if u.status == 'USE' %}
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs">ÏÇ¨Ïö©</span>
                            {% elif u.status == 'WAIT' %}
                            <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs">ÎåÄÍ∏∞</span>
                            {% else %}
                            <span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs">ÌÉàÌá¥</span>
                            {% endif %}
                        </td>
                        <td class="p-2">{{ u.created_at.strftime('%Y-%m-%d %H:%M:%S') if u.created_at else '' }}</td>
                        <td class="p-2">{{ u.updated_at.strftime('%Y-%m-%d %H:%M:%S') if u.updated_at else '' }}</td>
                        <td class="p-2 text-center space-x-2">
                            <button type="button" class="text-indigo-600 hover:underline"
                                onclick="openUserModal({{ u.uid }})">Í¥ÄÎ¶¨</button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center text-gray-500 py-6">
                            Îì±Î°ùÎêú ÏÇ¨Ïö©ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>

            <!-- ‚úÖ ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò + ÌëúÏãú Í∞úÏàò -->
            <div class="w-full mt-6 text-sm flex items-center justify-center relative py-2">

                <!-- ‚óÄÔ∏è ÌéòÏù¥Ïßï (Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨) -->
                <div class="flex justify-center items-center space-x-1">
                    <button onclick="doPaging(1)" class="px-3 py-1 border rounded 
                        {% if page.page == 1 %}opacity-50 cursor-not-allowed{% else %}hover:bg-gray-100{% endif %}" {%
                        if page.page==1 %}disabled{% endif %}>
                        &laquo;
                    </button>

                    <button onclick="doPaging({{ page.start_page - page.page_size }})" class="px-3 py-1 border rounded 
                        {% if not page.has_prev %}opacity-50 cursor-not-allowed{% else %}hover:bg-gray-100{% endif %}"
                        {% if not page.has_prev %}disabled{% endif %}>
                        &lsaquo;
                    </button>

                    {% for p in range(page.start_page, page.end_page + 1) %}
                    <button onclick="doPaging({{ p }})" class="px-3 py-1 border rounded 
                        {% if p == page.page %}bg-indigo-600 text-white{% else %}hover:bg-gray-100{% endif %}">
                        {{ p }}
                    </button>
                    {% endfor %}

                    <button onclick="doPaging({{ page.start_page + page.page_size }})" class="px-3 py-1 border rounded 
                        {% if not page.has_next %}opacity-50 cursor-not-allowed{% else %}hover:bg-gray-100{% endif %}"
                        {% if not page.has_next %}disabled{% endif %}>
                        &rsaquo;
                    </button>

                    <button onclick="doPaging({{ page.page_total }})"
                        class="px-3 py-1 border rounded 
                        {% if page.page == page.page_total %}opacity-50 cursor-not-allowed{% else %}hover:bg-gray-100{% endif %}" {% if page.page==page.page_total
                        %}disabled{% endif %}>
                        &raquo;
                    </button>
                </div>

                <!-- ‚ñ∂Ô∏è ÌëúÏãú Í∞úÏàò (Í∞ôÏùÄ flex ÎùºÏù∏ Ïò§Î•∏Ï™Ω ÎÅùÏúºÎ°ú ÏûêÎèô Ï†ïÎ†¨) -->
                <div class="flex items-center gap-2 text-gray-700 absolute right-6">
                    <label>ÌëúÏãú:</label>
                    <select name="list_size"
                        class="border rounded px-2 py-1 focus:ring focus:ring-indigo-200 focus:border-indigo-400"
                        onchange="doSearch(1)">
                        {% for size in [10, 25, 50, 100] %}
                        <option value="{{ size }}" {% if size==page.list_size %}selected{% endif %}>{{ size }}</option>
                        {% endfor %}
                    </select>
                    <span class="text-gray-500">Í∞ú</span>
                </div>
            </div>


            <!-- Ïú†ÏßÄÏö© ÌûàÎì† -->
            <input type="hidden" id="page" name="page" value="{{ page.page }}">
            <input type="hidden" name="page_size" value="{{ page.page_size }}">

        </form>
    </div>

    <p class="text-xs text-gray-500 text-center mt-2">
        Ï¥ù {{ page.list_total }}Î™Ö / {{ page.page_total }}ÌéòÏù¥ÏßÄ
    </p>
</div>


<!-- ü™Ñ ÏÇ¨Ïö©Ïûê ÏàòÏ†ï Î™®Îã¨ -->
<div id="user_modal" class="modal-layer hidden fixed inset-0 flex items-center justify-center z-[100]">
    <div class="bg-gray-50 rounded-xl shadow-xl w-[32rem] max-h-[90vh] flex flex-col relative overflow-hidden">

        <!-- ‚úÖ ÏÉÅÎã® Ìó§Îçî -->
        <div class="flex justify-between items-center p-6 border-b bg-gray-50 rounded-t-xl">
            <h3 class="text-lg font-bold text-gray-800">ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏàòÏ†ï</h3>
            <button onclick="closeUserAddModal()"
                class="text-gray-closeUserModal hover:text-gray-700 text-xl leading-none">‚úï</button>
        </div>
        <!-- ‚úÖ Ïä§ÌÅ¨Î°§ Í∞ÄÎä•Ìïú Î≥∏Î¨∏ -->
        <div class="p-6 overflow-y-auto flex-1 bg-white">
            <form method="post" action="{{ request.base_url }}admin/users" class="space-y-3 text-sm">
                <div class="space-y-3 text-sm">
                    <div>
                        <label class="block mb-1 text-gray-600">Ïù¥Î¶Ñ</label>
                        <input name="name" type="text"
                            class="border rounded px-2 py-1 w-full focus:ring focus:ring-indigo-200">
                    </div>
                    <div>
                        <label class="block mb-1 text-gray-600">ÏïÑÏù¥Îîî</label>
                        <input name="id" type="text"
                            class="border rounded px-2 py-1 w-full focus:ring focus:ring-indigo-200">
                    </div>
                    <div>
                        <label class="block mb-1 text-gray-600">ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                        <input name="password" type="password"
                            class="border rounded px-2 py-1 w-full focus:ring focus:ring-indigo-200"
                            placeholder="Î≥ÄÍ≤Ω ÏãúÏóêÎßå ÏûÖÎ†•">
                    </div>
                    <div>
                        <label class="block mb-1 text-gray-600">ÏÉÅÌÉú</label>
                        <select name="status" class="border rounded px-2 py-1 w-full">
                            <option value="USE">ÏÇ¨Ïö©</option>
                            <option value="WAIT">ÎåÄÍ∏∞</option>
                            <option value="DEL">ÌÉàÌá¥</option>
                        </select>
                    </div>
                    <div>
                        <label class="block mb-1 text-gray-600">Í∂åÌïú</label>
                        <div class="border rounded-lg p-2 bg-gray-50 max-h-48 overflow-y-auto text-sm">
                            <table class="w-full border-collapse text-sm">
                                <thead class="sticky top-0 bg-gray-100 z-10">
                                    <tr class="border-b">
                                        <th class="p-2 w-12 text-center"><input type="checkbox" class="select-all"></th>
                                        <th class="p-2 text-left text-gray-700 font-medium">Í∂åÌïúÎ™Ö</th>
                                        <th class="p-2 text-left text-gray-700 font-medium">ÏÑ§Î™Ö</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for r in roles %}
                                    <tr class="border-b hover:bg-gray-100">
                                        <td class="p-2 text-center">
                                            <input type="checkbox" name="roles" value="{{ r.uid }}"
                                                class="role-checkbox cursor-pointer">
                                        </td>
                                        <td class="p-2 font-medium text-gray-800">{{ r.name }}</td>
                                        <td class="p-2 text-gray-600 text-xs truncate max-w-[14rem]"
                                            title="{{ r.description }}">
                                            {{ r.description or '' }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <!-- ‚úÖ ÌïòÎã® Î≤ÑÌäº -->
        <div class="border-t bg-gray-50 p-4 flex justify-center gap-3 rounded-b-xl">
            <button type="button" onclick="closeUserModal()"
                class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Ï∑®ÏÜå</button>
            <button type="button" onclick="saveUserModal()"
                class="px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-700 text-white">Ï†ÄÏû•</button>
        </div>
    </div>
</div>

<!-- üß© ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä Î™®Îã¨ -->
<div id="user_add_modal" class="modal-layer hidden fixed inset-0 flex items-center justify-center z-[100]">
    <div class="bg-gray-50 rounded-xl shadow-xl w-[32rem] max-h-[90vh] flex flex-col relative overflow-hidden">

        <!-- ‚úÖ ÏÉÅÎã® Ìó§Îçî -->
        <div class="flex justify-between items-center p-6 border-b bg-gray-50 rounded-t-xl">
            <h3 class="text-lg font-bold text-gray-800">ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä</h3>
            <button onclick="closeUserAddModal()" class="text-gray-500 hover:text-gray-700 text-xl leading-none">‚úï</button>
        </div>
        <!-- ‚úÖ Ïä§ÌÅ¨Î°§ Í∞ÄÎä•Ìïú Î≥∏Î¨∏ -->
        <div class="p-6 overflow-y-auto flex-1 bg-white">
            <form  method="post" action="{{ request.base_url }}admin/users" class="space-y-3 text-sm" >
                <div class="space-y-3 text-sm">
                    <div>
                        <label class="block mb-1 text-gray-600">Ïù¥Î¶Ñ</label>
                        <input name="name" type="text"
                            class="border rounded px-2 py-1 w-full focus:ring focus:ring-indigo-200">
                    </div>
                    <div>
                        <label class="block mb-1 text-gray-600">ÏïÑÏù¥Îîî</label>
                        <input name="id" type="text"
                            class="border rounded px-2 py-1 w-full focus:ring focus:ring-indigo-200">
                    </div>
                    <div>
                        <label class="block mb-1 text-gray-600">ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                        <input name="password" type="password"
                            class="border rounded px-2 py-1 w-full focus:ring focus:ring-indigo-200" placeholder="ÌïÑÏàò ÏûÖÎ†•">
                    </div>
                    <div>
                        <label class="block mb-1 text-gray-600">ÏÉÅÌÉú</label>
                        <select name="status" class="border rounded px-2 py-1 w-full">
                            <option value="WAIT">ÎåÄÍ∏∞</option>
                            <option value="USE">ÏÇ¨Ïö©</option>
                        </select>
                    </div>
                    <div>
                        <label class="block mb-1 text-gray-600">Í∂åÌïú</label>
                        <div class="border rounded-lg bg-gray-50 max-h-48 overflow-y-auto text-sm">
                            <table class="w-full border-collapse text-sm">
                                <thead class="sticky top-0 bg-gray-100 z-10">
                                    <tr class="border-b">
                                        <th class="p-2 w-12 text-center"><input type="checkbox" class="select-all"></th>
                                        <th class="p-2 text-left text-gray-700 font-medium">Í∂åÌïúÎ™Ö</th>
                                        <th class="p-2 text-left text-gray-700 font-medium">ÏÑ§Î™Ö</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for r in roles %}
                                    <tr class="border-b hover:bg-gray-100">
                                        <td class="p-2 text-center">
                                            <input type="checkbox" name="roles" value="{{ r.uid }}"
                                                class="add-role-checkbox cursor-pointer">
                                        </td>
                                        <td class="p-2 font-medium text-gray-800">{{ r.name }}</td>
                                        <td class="p-2 text-gray-600 text-xs truncate max-w-[14rem]"
                                            title="{{ r.description }}">
                                            {{ r.description or '' }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <!-- ‚úÖ ÌïòÎã® Î≤ÑÌäº -->
        <div class="border-t bg-gray-50 p-4 flex justify-center gap-3 rounded-b-xl">
            <button type="button" onclick="closeUserAddModal()"
                class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Ï∑®ÏÜå</button>
            <button type="button" onclick="saveUserAddModal()"
                class="px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-700 text-white">Ï†ÄÏû•</button>
        </div>
    </div>
</div>

<script>
    // ‚úÖ Ï†ÑÏ≤¥ ÏÑ†ÌÉù / Ìï¥Ï†ú Í∏∞Îä•
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".select-all").forEach(headerCheck => {
            headerCheck.addEventListener("change", () => {
                const table = headerCheck.closest("table");
                table.querySelectorAll("tbody input[type='checkbox']").forEach(cb => cb.checked = headerCheck.checked);
            });
        });
    });
    
    function doSearch(page = 1) {
        const form = document.querySelector("#search_form");
        const params = new URLSearchParams();
        form.querySelector("#page").value = page;
        form.querySelectorAll("input, select, textarea").forEach(el => {
            const name = el.name;
            if (!name) return;
            const value = (el.value || "").trim();

            // Í∞íÏù¥ ÏóÜÍ±∞ÎÇò Îπà Î¨∏ÏûêÏó¥Ïù¥Î©¥ Ï†úÏô∏
            if (value === "" || value === null || value === undefined) return;

            if (el.type === "checkbox") {
                if (el.checked) params.append(name, el.value || "true");
            } else if (el.type === "radio") {
                if (el.checked) params.append(name, value);
            } else {
                if (value !== "") params.append(name, value);
            }
        });
        location.href = form.action + "?" + params.toString();
    }

    function doPaging(pageNum) {
        if (pageNum < 1) pageNum = 1;
        doSearch(pageNum);
    }

    const panel = document.getElementById("detail_search_panel");
    const input = document.getElementById("search_input");

    function openDetailSearch() {
        panel.classList.remove("hidden", "opacity-0", "scale-y-0");
        setTimeout(() => panel.classList.add("opacity-100", "scale-y-100"), 10);
    }

    function closeDetailSearch() {
        panel.classList.remove("opacity-100", "scale-y-100");
        panel.classList.add("opacity-0", "scale-y-0");
        setTimeout(() => panel.classList.add("hidden"), 200);
    }

    function resetDetailSearch() {
        const form = document.querySelector("#search_form");
        form.querySelectorAll("#detail_search_panel input, #detail_search_panel select").forEach(el => {
            if (el.tagName === "SELECT") el.selectedIndex = 0;
            else el.value = "";
        });
    }

    document.addEventListener("click", (e) => {
        const opened = !panel.classList.contains("hidden");
        if (!opened) return;
        if (!panel.contains(e.target) && e.target !== input) closeDetailSearch();
    });


    async function openUserModal(uid) {
        showLoading();
        const modal = document.getElementById("user_modal");
        const form = modal.querySelector("form");

        try {
            const resp = await fetch(`{{ request.base_url }}admin/users/${uid}`);
            if (!resp.ok) throw new Error("ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.");
            const user = await resp.json();

            form.querySelector('[name="id"]').value = user.id || "";
            form.querySelector('[name="name"]').value = user.name || "";
            form.querySelector('[name="status"]').value = user.status || "WAIT";
            form.querySelector('[name="password"]').value = "";
            form.querySelectorAll('.role-checkbox').forEach(cb => {
                cb.checked = (user.roles || []).includes(parseInt(cb.value));
            });

            form.dataset.uid = uid;
            form.dataset.orig = JSON.stringify({
                name: user.name || "",
                id: user.id || "",
                status: user.status || "",
                password: ""
            });

            modal.classList.remove("hidden");
        } catch (err) {
            alert(err.message);
            closeUserModal();
        } finally {
            hideLoading();
        }
    }

    function closeUserModal() {
        const modal = document.getElementById("user_modal");
        modal.classList.add("hidden");
        modal.querySelector("form").reset();
    }


    // ‚úÖ ÏàòÏ†ïÎêú ÌïÑÎìúÎßå PATCH Ï†ÑÏÜ°
    async function saveUserModal() {
        showLoading();

        const form = document.querySelector("#user_modal form");
        const uid = form.dataset.uid;
        const orig = JSON.parse(form.dataset.orig);

        const current = {
            name: form.querySelector('[name="name"]').value.trim(),
            id: form.querySelector('[name="id"]').value.trim(),
            status: form.querySelector('[name="status"]').value,
            password: form.querySelector('[name="password"]').value.trim(),
            roles: Array.from(form.querySelectorAll('.role-checkbox:checked')).map(cb => parseInt(cb.value)),
        };

        // Î≥ÄÍ≤ΩÎêú ÌïÑÎìúÎßå Ï∂îÏ∂ú
        const updated = {};
        for (const key in current) {
            if (current[key] !== orig[key] && current[key] !== "") {
                updated[key] = current[key];
            }
        }

        if (Object.keys(updated).length === 0) {
            alert("Î≥ÄÍ≤ΩÎêú ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.");
            return;
        }

        try {
            const resp = await fetch(`{{ request.base_url }}admin/users/${uid}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(updated),
            });

            if (!resp.ok) {
                const errData = await resp.json().catch(() => ({}));
                const msg = errData.detail || errData.message || "ÏàòÏ†ï Ïã§Ìå®";
                throw new Error(`‚ùå ${msg}`);
            }

            alert("‚úÖ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.");
            closeUserModal();
            location.reload();
        } catch (err) {
            alert(err.message);
        } finally {
            hideLoading();
        }
    };

    function openUserAddModal() {
        document.getElementById("user_add_modal").classList.remove("hidden");
    }

    function closeUserAddModal() {
        const modal = document.getElementById("user_add_modal");
        modal.classList.add("hidden");
        modal.querySelector("form").reset();
    }

    async function saveUserAddModal() {
        showLoading();

        const form = document.querySelector("#user_add_modal form");
        const payload = {
            name: form.querySelector('[name="name"]').value.trim(),
            id: form.querySelector('[name="id"]').value.trim(),
            password: form.querySelector('[name="password"]').value.trim(),
            status: form.querySelector('[name="status"]').value,
            roles: Array.from(form.querySelectorAll(".add-role-checkbox:checked")).map(cb => parseInt(cb.value)),
        };

        try {
            const resp = await fetch(form.action, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });

            const data = await resp.json();
            if (!resp.ok) throw new Error(data.detail || "Îì±Î°ù Ïã§Ìå®");

            alert("‚úÖ ÏÇ¨Ïö©Ïûê Îì±Î°ùÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.");
            closeUserAddModal();
            location.reload();
        } catch (err) {
            alert(err.message);
        } finally {
            hideLoading();
        }
    };

</script>