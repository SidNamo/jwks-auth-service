<div class="bg-white shadow-md rounded-2xl p-6 relative">

    <!-- âœ… ìƒë‹¨ -->
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">ì–´í”Œë¦¬ì¼€ì´ì…˜ ê´€ë¦¬</h2>
    </div>

    <!-- ğŸ” í†µí•© ê²€ìƒ‰ + ìƒì„¸ ê²€ìƒ‰ -->
    <div class="mb-4">
        <form id="search_form" method="get" action="{{ request.base_url }}admin/apps"
            class="flex flex-col items-end text-sm gap-3">

            <!-- 1) í†µí•© ê²€ìƒ‰ í–‰ -->
            <div class="flex items-center justify-between gap-2 relative w-full">
                <!-- ì™¼ìª½: ì–´í”Œë¦¬ì¼€ì´ì…˜ ì¶”ê°€ ë²„íŠ¼ -->
                <button type="button"
                    class="bg-gray-200 text-gray-800 px-3 py-2 rounded text-sm hover:bg-gray-300 border border-gray-300"
                    onclick="openAppAddModal()">
                    ì–´í”Œë¦¬ì¼€ì´ì…˜ ì¶”ê°€
                </button>

                <!-- ì˜¤ë¥¸ìª½: ê²€ìƒ‰ì°½ + ë²„íŠ¼ -->
                <div class="flex items-center gap-2">
                    <input type="text" id="search_input" name="query" placeholder="ì´ë¦„, Client ID, UID ê²€ìƒ‰..."
                        value="{{ page.search.query or '' }}"
                        class="border border-gray-300 rounded-lg px-3 py-2 w-80 focus:ring focus:ring-indigo-200"
                        onfocus="openDetailSearch()">

                    <button type="button" class="bg-indigo-600 text-white px-4 py-2 rounded" onclick="doSearch(1)">
                        ê²€ìƒ‰
                    </button>
                </div>

                <!-- ğŸ“¦ ìƒì„¸ ê²€ìƒ‰ íŒ¨ë„ -->
                <div id="detail_search_panel"
                    class="absolute top-12 right-0 w-[30rem] bg-white border border-gray-300 rounded-lg shadow-lg opacity-0 scale-y-0 origin-top transition-all duration-300 ease-out hidden z-40">
                    <div class="p-5 relative">
                        <button type="button" onclick="resetDetailSearch()"
                            class="absolute right-4 top-4 text-sm bg-red-500 hover:bg-red-600 text-white rounded px-3 py-1 shadow-sm transition">
                            ì´ˆê¸°í™”
                        </button>

                        <h3 class="text-sm font-semibold mb-4 text-gray-700">ìƒì„¸ ê²€ìƒ‰</h3>

                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <label class="block mb-1 text-gray-600">UID</label>
                                <input type="text" name="uid" value="{{ page.search.uid or '' }}"
                                    class="border rounded px-2 py-1 w-full">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">ì•± ì´ë¦„</label>
                                <input type="text" name="name" value="{{ page.search.name or '' }}"
                                    class="border rounded px-2 py-1 w-full">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">í´ë¼ì´ì–¸íŠ¸ ID</label>
                                <input type="text" name="client_id" value="{{ page.search.client_id or '' }}"
                                    class="border rounded px-2 py-1 w-full">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">ì†Œìœ ì</label>
                                <input type="text" name="owner" value="{{ page.search.owner or '' }}"
                                    placeholder="uid, id, name" class="border rounded px-2 py-1 w-full">
                            </div>
                            <div class="col-span-2">
                                <label class="block mb-1 text-gray-600">ë“±ë¡ì¼</label>
                                <div class="flex items-center gap-2">
                                    <input type="date" name="created_dt_start"
                                        value="{{ page.search.created_dt_start or '' }}"
                                        class="border rounded px-2 py-1 w-full">
                                    <span>~</span>
                                    <input type="date" name="created_dt_end"
                                        value="{{ page.search.created_dt_end or '' }}"
                                        class="border rounded px-2 py-1 w-full">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- âœ… í…Œì´ë¸” -->
            <table class="w-full border-collapse text-sm mt-4">
                <thead>
                    <tr class="bg-gray-100 border-b">
                        <th class="p-2 text-left">UID</th>
                        <th class="p-2 text-left">ì´ë¦„</th>
                        <th class="p-2 text-left">Client ID</th>
                        <th class="p-2 text-left">ë“±ë¡ì¼</th>
                        <th class="p-2 text-left">ìˆ˜ì •ì¼</th>
                        <th class="p-2 text-center">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody>
                    {% if page.content %}
                    {% for app in page.content %}
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2">{{ app.uid }}</td>
                        <td class="p-2">{{ app.name }}</td>
                        <td class="p-2 font-mono text-xs text-gray-700">{{ app.client_id }}</td>
                        <td class="p-2">{{ app.created_at.strftime('%Y-%m-%d %H:%M:%S') if app.created_at else '' }}
                        </td>
                        <td class="p-2">{{ app.updated_at.strftime('%Y-%m-%d %H:%M:%S') if app.updated_at else '' }}
                        </td>
                        <td class="p-2 text-center space-x-2">
                            <button type="button" class="text-indigo-600 hover:underline"
                                onclick="openAppModal({{ app.uid }})">ê´€ë¦¬</button>
                            <button type="button" class="text-red-500 hover:underline"
                                onclick="deleteApp({{ app.uid }})">ì‚­ì œ</button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center text-gray-500 py-6">ë“±ë¡ëœ ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>

            <!-- âœ… í˜ì´ì§€ë„¤ì´ì…˜ + í‘œì‹œ ê°œìˆ˜ -->
            <div class="w-full mt-6 text-sm flex items-center justify-center relative py-2">

                <!-- â—€ï¸ í˜ì´ì§• (ê°€ìš´ë° ì •ë ¬) -->
                <div class="flex justify-center items-center space-x-1">
                    <button onclick="doPaging(1)"
                        class="px-3 py-1 border rounded 
                                    {% if page.page == 1 %}opacity-50 cursor-not-allowed{% else %}hover:bg-gray-100{% endif %}" {% if
                        page.page==1 %}disabled{% endif %}>
                        &laquo;
                    </button>

                    <button onclick="doPaging({{ page.start_page - page.page_size }})"
                        class="px-3 py-1 border rounded 
                                    {% if not page.has_prev %}opacity-50 cursor-not-allowed{% else %}hover:bg-gray-100{% endif %}" {% if not page.has_prev %}disabled{% endif %}>
                        &lsaquo;
                    </button>

                    {% for p in range(page.start_page, page.end_page + 1) %}
                    <button onclick="doPaging({{ p }})"
                        class="px-3 py-1 border rounded 
                                    {% if p == page.page %}bg-indigo-600 text-white{% else %}hover:bg-gray-100{% endif %}">
                        {{ p }}
                    </button>
                    {% endfor %}

                    <button onclick="doPaging({{ page.start_page + page.page_size }})"
                        class="px-3 py-1 border rounded 
                                    {% if not page.has_next %}opacity-50 cursor-not-allowed{% else %}hover:bg-gray-100{% endif %}" {% if not page.has_next %}disabled{% endif %}>
                        &rsaquo;
                    </button>

                    <button onclick="doPaging({{ page.page_total }})"
                        class="px-3 py-1 border rounded 
                                    {% if page.page == page.page_total %}opacity-50 cursor-not-allowed{% else %}hover:bg-gray-100{% endif %}" {% if
                        page.page==page.page_total %}disabled{% endif %}>
                        &raquo;
                    </button>
                </div>

                <!-- â–¶ï¸ í‘œì‹œ ê°œìˆ˜ (ê°™ì€ flex ë¼ì¸ ì˜¤ë¥¸ìª½ ëìœ¼ë¡œ ìë™ ì •ë ¬) -->
                <div class="flex items-center gap-2 text-gray-700 absolute right-6">
                    <label>í‘œì‹œ:</label>
                    <select name="list_size"
                        class="border rounded px-2 py-1 focus:ring focus:ring-indigo-200 focus:border-indigo-400"
                        onchange="doSearch(1)">
                        {% for size in [10, 25, 50, 100] %}
                        <option value="{{ size }}" {% if size==page.list_size %}selected{% endif %}>{{ size }}</option>
                        {% endfor %}
                    </select>
                    <span class="text-gray-500">ê°œ</span>
                </div>
            </div>

            <!-- ìœ ì§€ìš© íˆë“  -->
            <input type="hidden" id="page" name="page" value="{{ page.page }}">
            <input type="hidden" name="page_size" value="{{ page.page_size }}">

        </form>
    </div>

    <p class="text-xs text-gray-500 text-center mt-2">
        ì´ {{ page.list_total }}ê°œ / {{ page.page_total }}í˜ì´ì§€
    </p>
</div>


<!-- ğŸ§© ì•± ê´€ë¦¬ ëª¨ë‹¬ -->
<div id="app_modal" class="modal-layer hidden fixed inset-0 flex items-center justify-center z-[100]">
    <div class="bg-gray-50 rounded-xl shadow-xl w-[32rem] max-h-[90vh] flex flex-col relative overflow-hidden">

        <!-- âœ… ìƒë‹¨ í—¤ë” -->
        <div class="flex justify-between items-center p-6 border-b bg-gray-50 rounded-t-xl">
            <h3 class="text-lg font-bold text-gray-800">ì–´í”Œë¦¬ì¼€ì´ì…˜ ê´€ë¦¬</h3>
            <button onclick="closeAppModal()" class="text-gray-500 hover:text-gray-700 text-xl leading-none">âœ•</button>
        </div>

        <!-- âœ… ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ë³¸ë¬¸ -->
        <div class="p-6 overflow-y-auto flex-1 bg-white">
            <form id="app_form" class="space-y-3 text-sm">
                <!-- ì•± ì´ë¦„ -->
                <div>
                    <label class="block mb-1 text-gray-600">ì•± ì´ë¦„</label>
                    <input name="name" type="text" class="border rounded px-2 py-1 w-full">
                </div>

                <!-- Client ID -->
                <div>
                    <label class="block mb-1 text-gray-600">Client ID</label>
                    <div class="flex items-center gap-2">
                        <input name="client_id" type="text" class="border rounded px-2 py-1 w-full">
                        <button type="button" onclick="generate('CLIENT_ID')"
                            class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm whitespace-nowrap min-w-[80px] flex-shrink-0">
                            ì‹ ê·œ ë°œê¸‰
                        </button>
                    </div>
                </div>

                <!-- Client Secret -->
                <div>
                    <label class="block mb-1 text-gray-600">Client Secret</label>
                    <div class="flex items-center gap-2">
                        <input name="client_secret" type="text" class="border rounded px-2 py-1 w-full">
                        <button type="button" onclick="generate('CLIENT_SECRET')"
                            class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm whitespace-nowrap min-w-[80px] flex-shrink-0">
                            ì‹ ê·œ ë°œê¸‰
                        </button>
                    </div>
                </div>

                <!-- í—ˆìš© IP -->
                <div>
                    <label class="block mb-1 text-gray-600">í—ˆìš© IP</label>
                    <textarea name="allowed_ips" rows="4"
                        class="border rounded px-2 py-1 w-full font-mono text-xs resize-none" placeholder="ì˜ˆì‹œ:
    10.10.100.1
    10.10.100.22~10.10.100.25
    192.168.0.0/24
    2001:db8::/64
    172.16.0.1/255.255.255.0"></textarea>
                    <p class="text-xs text-gray-500 mt-1">
                        IPv4, IPv6, CIDR, Subnet Mask, IP Range(10.0.0.1-10.0.0.10 / 10.0.0.1~10.0.0.10) ëª¨ë‘ ì§€ì›í•©ë‹ˆë‹¤.
                    </p>
                </div>

                <!-- âœ… ì†Œìœ ì ê´€ë¦¬ -->
                <div>
                    <label class="block mb-1 text-gray-600">ì†Œìœ ì</label>
                    <div class="border rounded-lg p-3 bg-gray-50 text-sm space-y-3">
                        <!-- ì„ íƒëœ ì†Œìœ ì ëª©ë¡ -->
                        <table class="w-full border-collapse text-sm bg-white border">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 text-center w-20">UID</th>
                                    <th class="p-2 text-left w-1/3">ì´ë¦„</th>
                                    <th class="p-2 text-left w-1/3">ì•„ì´ë””</th>
                                    <th class="p-2 text-center w-20">ì‚­ì œ</th>
                                </tr>
                            </thead>
                            <tbody id="owner_table_body">
                                <tr>
                                    <td colspan="4" class="text-center text-gray-400 py-2">ì†Œìœ ì ì—†ìŒ</td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- ê²€ìƒ‰ ì…ë ¥ -->
                        <div class="flex items-center gap-2">
                            <input type="text" id="owner_search" placeholder="UID, ID, ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰"
                                class="border rounded px-2 py-1 flex-1 text-sm">
                            <button type="button" onclick="searchOwner()"
                                class="bg-indigo-500 text-white px-3 py-1 rounded text-sm">ê²€ìƒ‰</button>
                        </div>

                        <!-- ê²€ìƒ‰ ê²°ê³¼ -->
                        <table class="w-full border-collapse text-sm bg-white border">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 text-center w-20">UID</th>
                                    <th class="p-2 text-left w-1/3">ì´ë¦„</th>
                                    <th class="p-2 text-left w-1/3">ì•„ì´ë””</th>
                                    <th class="p-2 text-center w-20">ì¶”ê°€</th>
                                </tr>
                            </thead>
                            <tbody id="owner_result_body">
                                <tr>
                                    <td colspan="4" class="text-center text-gray-400 py-2">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ğŸ”‘ RSA í‚¤ ì •ë³´ -->
                <div>
                    <!-- ì œëª© + ë²„íŠ¼ì„ flexë¡œ ì •ë ¬ -->
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-gray-700 font-semibold text-sm">RSA Key ì •ë³´</h3>
                        <button type="button" onclick="generate('RSA')"
                            class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm">
                            ì‹ ê·œ ë°œê¸‰
                        </button>
                    </div>

                    <!-- âœ… ìŠ¤í¬ë¡¤ ë°•ìŠ¤ -->
                    <div id="key_scroll_box"
                        class="border rounded-lg bg-gray-50 p-3 max-h-80 overflow-y-auto shadow-inner">
                        <div id="key_list" class="space-y-3">
                            <div class="text-center text-gray-400 text-sm py-2 border rounded bg-gray-50">
                                ë“±ë¡ëœ í‚¤ ì—†ìŒ
                            </div>
                        </div>
                    </div>
                </div>

            </form>
        </div>

        <!-- âœ… í•˜ë‹¨ ë²„íŠ¼ -->
        <div class="border-t bg-gray-50 p-4 flex justify-center gap-3 rounded-b-xl">
            <button type="button" onclick="closeAppModal()"
                class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">ì·¨ì†Œ</button>
            <button type="button" onclick="saveAppModal()"
                class="px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-700 text-white">ì €ì¥</button>
        </div>
    </div>
</div>

<!-- âœ… JS -->
<script>
    let ownerList = [];
    let appKeys = [];

    function doSearch(page = 1) {
        const form = document.querySelector("#search_form");
        const params = new URLSearchParams();
        form.querySelector("#page").value = page;
        form.querySelectorAll("input, select").forEach(el => {
            if (el.name && el.value.trim() !== "") params.append(el.name, el.value);
        });
        location.href = form.action + "?" + params.toString();
    }

    function doPaging(p) {
        doSearch(p);
    }

    const panel = document.getElementById("detail_search_panel");
    const input = document.getElementById("search_input");

    function openDetailSearch() {
        panel.classList.remove("hidden", "opacity-0", "scale-y-0");
        setTimeout(() => panel.classList.add("opacity-100", "scale-y-100"), 10);
    }

    function closeDetailSearch() {
        panel.classList.remove("opacity-100", "scale-y-100");
        panel.classList.add("opacity-0", "scale-y-0");
        setTimeout(() => panel.classList.add("hidden"), 200);
    }

    function resetDetailSearch() {
        document.querySelectorAll("#detail_search_panel input").forEach(el => el.value = "");
    }

    document.addEventListener("click", e => {
        const opened = !panel.classList.contains("hidden");
        if (!opened) return;
        if (!panel.contains(e.target) && e.target !== input) closeDetailSearch();
    });


    /* âœ… openAppModal */
    async function openAppModal(uid) {
        showLoading();
        const modal = document.getElementById("app_modal");
        const form = document.getElementById("app_form");

        try {
            const resp = await fetch(`{{ request.base_url }}admin/apps/${uid}`);
            const app = await resp.json();
            if (!resp.ok) throw new Error("ì•± ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

            form.dataset.uid = uid;
            form.querySelector('[name="name"]').value = app.name || "";
            form.querySelector('[name="client_id"]').value = app.client_id || "";

            const clientSecret = form.querySelector('[name="client_secret"]');
            clientSecret.dataset.masking = app.client_secret || "";
            clientSecret.value = "********";

            form.querySelector('[name="allowed_ips"]').value = (app.allowed_ips || []).join("\n");

            ownerList = app.owners || [];
            appKeys = app.keys || [];

            renderOwners();
            renderKeys();
            setMasking();

            form.dataset.orig = JSON.stringify({
                name: app.name || "",
                client_id: app.client_id || "",
                client_secret: app.client_secret || "",
                allowed_ips: app.allowed_ips || [],
                owners: (app.owners || []).map(o => o.uid),
                keys: app.keys || []
            });
            
            modal.querySelector("h3").textContent = "ì–´í”Œë¦¬ì¼€ì´ì…˜ ê´€ë¦¬";

            modal.classList.remove("hidden");
        } catch (e) {
            alert(e.message);
        } finally {
            hideLoading();
        }
    }

    function closeAppModal() {

        const modal = document.getElementById("app_modal");
        const form = document.getElementById("app_form");
        modal.classList.add("hidden");
        form.reset();

        clearMasking(); // ì´ë²¤íŠ¸ ì œê±°

        ownerList = [];
        appKeys = [];

        // âœ… ì†Œìœ ì ê´€ë ¨ í…Œì´ë¸” ì´ˆê¸°í™”
        document.getElementById("owner_table_body").innerHTML = `
            <tr><td colspan="4" class="text-center text-gray-400 py-2">ì†Œìœ ì ì—†ìŒ</td></tr>`;
        document.getElementById("owner_result_body").innerHTML = `
            <tr><td colspan="4" class="text-center text-gray-400 py-2">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</td></tr>`;

        // âœ… RSA í‚¤ ëª©ë¡ ì´ˆê¸°í™”
        document.getElementById("key_list").innerHTML = `
        <div class="text-center text-gray-400 text-sm py-2 border rounded bg-gray-50">
            ë“±ë¡ëœ í‚¤ ì—†ìŒ
        </div>`;
    }

    function renderKeys() {
        const list = document.getElementById("key_list");
        list.innerHTML = "";

        if (!appKeys || appKeys.length === 0) {
            list.innerHTML = `
            <div class="text-center text-gray-400 text-sm py-2 border rounded bg-gray-50">
                ë“±ë¡ëœ í‚¤ ì—†ìŒ
            </div>`;
            return;
        }

        appKeys.forEach((k, idx) => {
            const div = document.createElement("div");
            div.className = "border rounded-lg bg-white shadow-sm p-3 space-y-2 text-xs text-gray-700 relative"; // âœ… relative ì¶”ê°€ë¨

            div.innerHTML = `
            <!-- âŒ ì‚­ì œ ë²„íŠ¼ (í™•ì‹¤íˆ ìš°ì¸¡ ìƒë‹¨ ê³ ì •) -->
            <button type="button"
                class="absolute top-2 right-4 text-red-500 hover:text-red-700 text-base font-bold z-10"
                onclick="removeKey(${idx})">âœ•</button>

            <div class="grid grid-cols-1 gap-2">
                <div class="grid grid-cols-1">
                    <div>
                        <label class="text-gray-600 text-[11px] font-medium">KID</label>
                        <input type="text" class="border rounded px-2 py-1 w-full text-xs font-mono"
                            value="${k.kid || ''}" onchange="appKeys[${idx}].kid = this.value">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-gray-600 text-[11px] font-medium">ALG</label>
                        <input type="text" class="border rounded px-2 py-1 w-full text-xs"
                            value="${k.alg || ''}" onchange="appKeys[${idx}].alg = this.value" readonly>
                    </div>
                    <div>
                        <label class="text-gray-600 text-[11px] font-medium">USE</label>
                        <input type="text" class="border rounded px-2 py-1 w-full text-xs"
                            value="${k.use || ''}" onchange="appKeys[${idx}].use = this.value" readonly>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-gray-600 text-[11px] font-medium">ìƒì„±ì¼</label>
                        <input type="text" class="border rounded px-2 py-1 w-full text-xs"
                            value="${dateToFormat(k.created_at, 'yyyy.MM.dd HH:mm:ss')}"
                            onchange="appKeys[${idx}].created_at = this.value">
                    </div>
                    <div>
                        <label class="text-gray-600 text-[11px] font-medium">ë§Œë£Œì¼</label>
                        <input type="text" class="border rounded px-2 py-1 w-full text-xs"
                            value="${dateToFormat(k.expired_at, 'yyyy.MM.dd HH:mm:ss')}"
                            onchange="appKeys[${idx}].expired_at = this.value">
                    </div>
                </div>

                <div>
                    <p class="font-semibold text-gray-600 mb-1">Public Key</p>
                    <textarea
                        data-masking="${k.public_key || ''}"
                        data-key-index="${idx}"
                        data-field="public_key"
                        rows="3" 
                        class="w-full border rounded px-2 py-1 font-mono text-xs">********</textarea>
                </div>

                <div>
                    <p class="font-semibold text-gray-600 mb-1">Private Key</p>
                    <textarea
                        data-masking="${k.private_key || ''}"
                        data-key-index="${idx}"
                        data-field="private_key"
                        rows="3" 
                        class="w-full border rounded px-2 py-1 font-mono text-xs">********</textarea>
                </div>
            </div>
        `;
            list.appendChild(div);
        });
    }

    /* âœ… RSA í‚¤ ì‚­ì œ */
    function removeKey(index) {
        appKeys.splice(index, 1);
        renderKeys();
    }

    /* âœ… ë§ˆìŠ¤í‚¹ ì²˜ë¦¬ ê³µí†µ í•¨ìˆ˜ */
    function setMasking() {
        const maskTargets = document.querySelectorAll('[data-masking]');

        maskTargets.forEach(el => {
            // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
            const onFocus = () => {
                el.value = el.dataset.masking || "";
            };

            const onBlur = () => {
                const newVal = el.value || "";
                el.dataset.masking = newVal;
                el.value = "********";

                // âœ… appKeys ë°°ì—´ì—ë„ ì¦‰ì‹œ ë°˜ì˜
                const idx = el.dataset.keyIndex;
                const field = el.dataset.field;
                if (idx !== undefined && field) {
                    appKeys[idx][field] = newVal;
                }
            };

            // ì €ì¥
            el._maskingHandlers = { onFocus, onBlur };

            // íƒ€ì…ë³„ ë¶„ê¸° (input, textarea ë“±)
            if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
                el.addEventListener("focus", onFocus);
                el.addEventListener("blur", onBlur);
            }
        });
    }

    /* âœ… ë§ˆìŠ¤í‚¹ ì´ë²¤íŠ¸ ì œê±° */
    function clearMasking() {
        const maskTargets = document.querySelectorAll('[data-masking]');
        maskTargets.forEach(el => {
            if (el._maskingHandlers) {
                el.removeEventListener("focus", el._maskingHandlers.onFocus);
                el.removeEventListener("blur", el._maskingHandlers.onBlur);
                delete el._maskingHandlers;
            }
        });
    }


    /* âœ… í‚¤/ID/Secret ë°œê¸‰ ê³µí†µ í•¨ìˆ˜ */
    async function generate(type) {
        const url = `{{ request.base_url }}admin/apps/generate?type=${encodeURIComponent(type)}`;

        showLoading();
        try {
            const resp = await fetch(url, { method: "GET" });
            const data = await resp.json();
            if (!resp.ok) throw new Error(data.detail || data.message || "ìƒì„± ì‹¤íŒ¨");

            const form = document.getElementById("app_form");
            if (type === "CLIENT_ID") {
                form.querySelector('[name="client_id"]').value = data.client_id;
            } else if (type === "CLIENT_SECRET") {
                const el = form.querySelector('[name="client_secret"]');
                el.dataset.masking = data.client_secret;
                el.value = "********";  // âœ… ë®ì–´ì“°ê¸°
            } else if (type === "RSA") {
                if (!appKeys) appKeys = [];
                appKeys.unshift(data.key); // âœ… ìƒë‹¨ ì¶”ê°€
                renderKeys();
                clearMasking();
                setMasking();
            }
        } catch (err) {
            alert(err.message);
        } finally {
            hideLoading();
        }
    }

    /* âœ… ì†Œìœ ì ë Œë”ë§ (ê¸°ì¡´ ìœ ì§€) */
    function renderOwners() {
        const tbody = document.getElementById("owner_table_body");
        tbody.innerHTML = "";
        if (!ownerList || ownerList.length === 0) {
            tbody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-400 py-2">ì†Œìœ ì ì—†ìŒ</td></tr>`;
            return;
        }
        ownerList.forEach(o => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="p-2 text-gray-700 text-center">${o.uid}</td>
                <td class="p-2">${o.name}</td>
                <td class="p-2">${o.id}</td>
                <td class="p-2 text-center">
                    <button type="button" class="text-red-500 text-xs hover:underline" onclick="removeOwner(${o.uid})">ì‚­ì œ</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    /* âœ… ì†Œìœ ì ê²€ìƒ‰ */
    async function searchOwner() {
        showLoading();
        const keyword = document.getElementById("owner_search").value.trim();

        const resp = await fetch(`{{ request.base_url }}admin/apps/search_user?keyword=${encodeURIComponent(keyword)}`);
        const results = await resp.json();

        const tbody = document.getElementById("owner_result_body");
        tbody.innerHTML = "";

        const users = results.data || []; // âœ… data í•„ë“œë§Œ ì‚¬ìš©
        if (users.length === 0) {
            tbody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-400 py-2">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</td></tr>`;
            hideLoading();
            return;
        }

        users.forEach(u => {
            const exists = ownerList.some(o => o.uid === u.uid);
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="p-2 text-center text-gray-700">${u.uid}</td>
                <td class="p-2">${u.name}</td>
                <td class="p-2">${u.id}</td>
                <td class="p-2 text-center">
                    <button type="button" class="text-indigo-600 text-xs inline-flex items-center justify-center whitespace-nowrap hover:underline"
                        onclick="addOwner(${u.uid}, '${u.name}', '${u.id}')">ì¶”ê°€</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        hideLoading();
    }


    /* âœ… ì†Œìœ ì ì¶”ê°€ â€” í…Œì´ë¸”ì—ë§Œ ë°˜ì˜ */
    function addOwner(uid, name, id) {
        if (!ownerList.some(o => o.uid === uid)) {
            ownerList.push({ uid, name, id });
            renderOwners();
        }
    }

    /* âœ… ì†Œìœ ì ì œê±° â€” í…Œì´ë¸”ì—ì„œë§Œ ì œê±° */
    function removeOwner(uid) {
        ownerList = ownerList.filter(o => o.uid !== uid);
        renderOwners();
    }

    /* âœ… ì €ì¥ ì‹œ owners í¬í•¨í•˜ì—¬ PATCH ì „ì†¡ */
    async function saveExistingAppModal() {
        if (!await confirm("ì •ë§ ì´ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            return; // âŒ ì·¨ì†Œí•œ ê²½ìš° ì•„ë¬´ê²ƒë„ ì•ˆ í•¨
        }

        showLoading();

        const form = document.getElementById("app_form");
        const uid = form.dataset.uid;
        const orig = JSON.parse(form.dataset.orig || "{}");

        // í˜„ì¬ ì…ë ¥ê°’ ìˆ˜ì§‘
        const current = {
            name: form.querySelector('[name="name"]').value.trim(),
            client_id: form.querySelector('[name="client_id"]').value.trim(),
            client_secret: form.querySelector('[name="client_secret"]').dataset.masking || "",
            allowed_ips: form.querySelector('[name="allowed_ips"]').value
                .split("\n")
                .map(ip => ip.trim())
                .filter(ip => ip !== ""),
            owners: ownerList.map(o => o.uid),
            keys: appKeys
        };

        // ë³€ê²½ëœ í•„ë“œë§Œ ì¶”ì¶œ
        const updated = {};
        for (const key in current) {
            const oldVal = JSON.stringify(orig[key]);
            const newVal = JSON.stringify(current[key]);
            if (oldVal !== newVal) {
                updated[key] = current[key];
            }
        }

        if (Object.keys(updated).length === 0) {
            alert("ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
            hideLoading();
            return;
        }

        try {
            const resp = await fetch(`{{ request.base_url }}admin/apps/${uid}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(updated)
            });

            const data = await resp.json();
            if (!resp.ok) throw new Error(data.detail || data.message || "ì €ì¥ ì‹¤íŒ¨");

            alert("âœ… ì–´í”Œë¦¬ì¼€ì´ì…˜ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            closeAppModal();
            location.reload();
        } catch (err) {
            alert(err.message);
        } finally {
            hideLoading();
        }
    }
    
    /* âœ… ì‹ ê·œ ìƒì„± ëª¨ë‹¬ ì—´ê¸° */
    function openAppAddModal() {
        const modal = document.getElementById("app_modal");
        const form = document.getElementById("app_form");

        // í¼ ì´ˆê¸°í™”
        form.reset();
        delete form.dataset.uid;
        delete form.dataset.orig;

        ownerList = [];
        appKeys = [];

        // ë Œë”ë§ ì´ˆê¸°í™”
        renderOwners();
        renderKeys();
        clearMasking();

        // ê¸°ë³¸ê°’
        form.querySelector('[name="client_id"]').value = "";
        form.querySelector('[name="client_secret"]').value = "";
        form.querySelector('[name="allowed_ips"]').value = "";

        modal.querySelector("h3").textContent = "ì–´í”Œë¦¬ì¼€ì´ì…˜ ì¶”ê°€";

        modal.classList.remove("hidden");
    }

    /* âœ… ì‹ ê·œ ìƒì„± ì €ì¥ */
    async function saveAppAddModal() {
        if (!await confirm("ìƒˆë¡œìš´ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        showLoading();
        const form = document.getElementById("app_form");

        const payload = {
            name: form.querySelector('[name="name"]').value.trim(),
            client_id: form.querySelector('[name="client_id"]').value.trim(),
            client_secret: form.querySelector('[name="client_secret"]').dataset.masking || "",
            allowed_ips: form.querySelector('[name="allowed_ips"]').value
                .split("\n").map(ip => ip.trim()).filter(ip => ip !== ""),
            owners: ownerList.map(o => o.uid),
            keys: appKeys
        };

        try {
            const resp = await fetch(`{{ request.base_url }}admin/apps`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await resp.json();
            if (!resp.ok) throw new Error(data.detail || data.message || "ì¶”ê°€ ì‹¤íŒ¨");

            alert("âœ… ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            closeAppModal();
            location.reload();
        } catch (err) {
            alert(err.message);
        } finally {
            hideLoading();
        }
    }

    /* âœ… ì €ì¥ ë²„íŠ¼ ìˆ˜ì • */
    function saveAppModal() {
        const form = document.getElementById("app_form");
        if (form.dataset.uid) {
            // ìˆ˜ì •
            saveExistingAppModal();
        } else {
            // ìƒì„±
            saveAppAddModal();
        }
    }
</script>